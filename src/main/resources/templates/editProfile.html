<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Notepad - Edit Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- navbar -->
  <header class="w-full h-[70px] flex justify-between items-center bg-green-100 px-5 box-border">
    <div class="flex items-center">
      <a href="/"><img src="/img/logo.png" alt="Logo" class="h-[43px]"></a>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center bg-white px-3 py-1 rounded-l-md">
        <img src="/img/search.png" alt="Search Icon" class="w-4 h-4 mr-2">
        <input type="text" placeholder="Search notes" class="text-sm border-none outline-none"/>
      </div>
      <a href="/user/notes"><img src="/img/myNote.png" alt="myNote Icon" class="h-10"></a>
      <a href="/user/notes/upload"><img src="/img/upload.png" alt="Upload Icon" class="h-10"></a>
      <a href="/user/profile"><img src="/img/profile.png" alt="Profile Icon" class="h-10"></a>
    </div>
  </header>
  <!-- navbar end -->

    <!-- Main Content -->
    <main class="mx-auto max-w-6xl p-8 bg-white mt-4 rounded-lg">
        <h1 class="mb-8 text-4xl font-bold">Profile</h1>

        <form id="profileForm" class="grid grid-cols-1 gap-8 md:grid-cols-2">
            <!-- Left Column -->
            <div class="space-y-6">
                <div>
                    <h2 class="mb-4 text-xl font-bold">Avatar Profile</h2>
                    <div class="flex flex-col items-start">
                        <div id="profileImageContainer" class="mb-4 h-32 w-32 overflow-hidden rounded-full border-2 flex items-center justify-center bg-white">
                            <img id="profileImage" class="h-full w-full object-cover hidden" alt="Profile Picture">
                            <svg id="profileIcon" xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <label for="profilePicture" class="text-black underline cursor-pointer">
                            Upload Picture
                        </label>
                        <input type="file" id="profilePicture" accept="image/*" class="hidden">
                        <!-- Hidden input to track if image was changed -->
                        <input type="hidden" id="imageChanged" value="false">
                    </div>
                </div>

                <div class="space-y-4">
                    <button type="button" id="linkedinBtn" class="flex items-center gap-2">
                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/mdi_linkedin-1kMkmeryjsjlD3Rnvvex4zuc38enni.png" alt="LinkedIn" class="w-6 h-6">
                        <span id="linkedinText">Add LinkedIn</span>
                    </button>
                    <button type="button" id="instagramBtn" class="flex items-center gap-2">
                        <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/iconsax-instagram-lr8l3JZrI0k0CSIaJSohbMZCCUNBqZ.png" alt="Instagram" class="w-6 h-6">
                        <span id="instagramText">Add Instagram</span>
                    </button>
                </div>

                <div>
                    <h2 class="mb-2 text-xl font-bold">About Me</h2>
                    <textarea name="aboutMe" id="aboutMe" class="h-20 w-full border border-gray-300 rounded-md p-2"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <div>
                    <label class="mb-2 block text-xl font-bold">First Name</label>
                    <input type="text" name="firstName" id="firstName" class="w-full border border-gray-300 rounded-md p-2">
                </div>

                <div>
                    <label class="mb-2 block text-xl font-bold">Last Name</label>
                    <input type="text" name="lastName" id="lastName" class="w-full border border-gray-300 rounded-md p-2">
                </div>

                <div>
                    <label class="mb-2 block text-xl font-bold">E-mail</label>
                    <input type="email" name="email" id="email" class="w-full border border-gray-300 rounded-md p-2">
                </div>

                <div>
                    <label class="mb-2 block text-xl font-bold">Password</label>
                    <div class="relative">
                        <input type="password" name="password" id="password" class="w-full border border-gray-300 rounded-md p-2 pr-10">
                        <button type="button" id="togglePassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="mb-2 block text-xl font-bold">Repeat Password</label>
                    <div class="relative">
                        <input type="password" name="repeatPassword" id="repeatPassword" class="w-full border border-gray-300 rounded-md p-2 pr-10">
                        <button type="button" id="toggleRepeatPassword" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="passwordError" class="text-red-500 mt-1 text-sm hidden">Password yang anda masukkan berbeda!</p>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="submit" id="updateProfileBtn" class="bg-emerald-400 px-6 py-2 text-black hover:bg-emerald-500 rounded-md">
                        Update Profile
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved user data if available
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            // Populate form fields with existing data
            if (userData.firstName) document.getElementById('firstName').value = userData.firstName;
            if (userData.lastName) document.getElementById('lastName').value = userData.lastName;
            if (userData.email) document.getElementById('email').value = userData.email;
            if (userData.aboutMe) document.getElementById('aboutMe').value = userData.aboutMe;
            
            // Display profile image if available
            if (userData.profileImage) {
                document.getElementById('profileImage').src = userData.profileImage;
                document.getElementById('profileImage').classList.remove('hidden');
                document.getElementById('profileIcon').classList.add('hidden');
            }
            
            // Update social media connection status
            if (userData.linkedinConnected) {
                document.getElementById('linkedinText').textContent = 'LinkedIn Connected';
            }
            
            if (userData.instagramConnected) {
                document.getElementById('instagramText').textContent = 'Instagram Connected';
            }
            
            // Profile picture upload
            document.getElementById('profilePicture').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const profileImage = document.getElementById('profileImage');
                        profileImage.src = event.target.result;
                        profileImage.classList.remove('hidden');
                        document.getElementById('profileIcon').classList.add('hidden');
                        
                        // Mark that image was changed
                        document.getElementById('imageChanged').value = 'true';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Password visibility toggle
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                    `;
                } else {
                    passwordInput.type = 'password';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    `;
                }
            });
            
            // Repeat password visibility toggle
            document.getElementById('toggleRepeatPassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('repeatPassword');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                        </svg>
                    `;
                } else {
                    passwordInput.type = 'password';
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    `;
                }
            });
            
            // Password validation
            function validatePasswords() {
                const password = document.getElementById('password').value;
                const repeatPassword = document.getElementById('repeatPassword').value;
                const errorElement = document.getElementById('passwordError');
                
                if (password && repeatPassword && password !== repeatPassword) {
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    errorElement.classList.add('hidden');
                    return true;
                }
            }
            
            document.getElementById('password').addEventListener('input', validatePasswords);
            document.getElementById('repeatPassword').addEventListener('input', validatePasswords);
            
            // LinkedIn connection
            document.getElementById('linkedinBtn').addEventListener('click', function() {
                const linkedinText = document.getElementById('linkedinText');
                if (linkedinText.textContent === 'Add LinkedIn') {
                    // Simulate LinkedIn connection
                    linkedinText.textContent = 'LinkedIn Connected';
                } else {
                    linkedinText.textContent = 'Add LinkedIn';
                }
            });
            
            // Instagram connection
            document.getElementById('instagramBtn').addEventListener('click', function() {
                const instagramText = document.getElementById('instagramText');
                if (instagramText.textContent === 'Add Instagram') {
                    // Simulate Instagram connection
                    instagramText.textContent = 'Instagram Connected';
                } else {
                    instagramText.textContent = 'Add Instagram';
                }
            });
            
            // Form submission - FIXED VERSION
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Validate passwords if both fields have values
                const password = document.getElementById('password').value;
                const repeatPassword = document.getElementById('repeatPassword').value;
                
                if ((password || repeatPassword) && !validatePasswords()) {
                    return; // Don't submit if passwords don't match
                }
                
                // Get form data
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    aboutMe: document.getElementById('aboutMe').value,
                    linkedinConnected: document.getElementById('linkedinText').textContent === 'LinkedIn Connected',
                    instagramConnected: document.getElementById('instagramText').textContent === 'Instagram Connected'
                };
                
                // Add password if provided
                if (password) {
                    formData.password = password;
                } else if (userData.password) {
                    // Keep existing password if not changed
                    formData.password = userData.password;
                }
                
                // Handle profile image
                const profileImage = document.getElementById('profileImage');
                const imageChanged = document.getElementById('imageChanged').value === 'true';
                
                // If image is visible and either it was changed or there was an image before
                if (!profileImage.classList.contains('hidden')) {
                    try {
                        // Try to get the image data with reduced quality to avoid localStorage limits
                        if (imageChanged) {
                            // Create a canvas to resize the image
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 300; // Max width for the image
                            
                            // Set canvas dimensions
                            let width = profileImage.naturalWidth;
                            let height = profileImage.naturalHeight;
                            
                            // Calculate new dimensions
                            if (width > maxWidth) {
                                const ratio = maxWidth / width;
                                width = maxWidth;
                                height = height * ratio;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Draw image on canvas with new dimensions
                            ctx.drawImage(profileImage, 0, 0, width, height);
                            
                            // Get compressed image data
                            formData.profileImage = canvas.toDataURL('image/jpeg', 0.7); // Reduce quality to 70%
                        } else {
                            // Keep existing image if not changed
                            formData.profileImage = userData.profileImage;
                        }
                    } catch (error) {
                        console.error('Error processing image:', error);
                        // If there's an error, try to use the original image
                        formData.profileImage = profileImage.src;
                    }
                }
                
                // Save data to localStorage
                try {
                    localStorage.setItem('userData', JSON.stringify(formData));
                    // Redirect to profile page
                    window.location.href = 'profile.html';
                } catch (error) {
                    console.error('Error saving data:', error);
                    // If localStorage fails (possibly due to size limits), show an error
                    alert('Gagal menyimpan data. Coba gunakan gambar yang lebih kecil.');
                }
            });
        });
    </script>
</body>
</html>